<script type="text/javascript">
google.maps.event.addDomListener(window, 'load', initialize(41.92, -87.65));

locations = [
  <% @venues.each do |venue| %>
  {
    id: <%= venue.id %>,
    lat: '<%= venue.latitude %>',
    lng: '<%= venue.longitude %>',
    name: '<%= venue.name %>',
    path: '<%= venue_path(venue) %>',
    isTry: <% if user_signed_in? and Try.where('user_id = ? AND venue_id = ?', current_user.id, venue.id).exists? %>true<% else %>false<% end %>,
    isBar: <% if venue.venuetype.isBar %>true<% else %>false<% end %>
  },
  <% end %>
];

for (i = 0; i < locations.length; i++) {
  var iconSymbol;
  if (locations[i]['isBar']) {
    iconSymbol = '/images/mug.svg';
  } else {
    iconSymbol = '/images/spoon-knife.svg';
  }
  marker = new google.maps.Marker({
    position: new google.maps.LatLng(locations[i]['lat'], locations[i]['lng']),
    map: map,
    icon: iconSymbol
  });
  marker.set('id', locations[i]['id']);
  marker.set('isBar', locations[i]['isBar']);
  marker.set('isTry', locations[i]['isTry']);
  markerList.push(marker);

  google.maps.event.addListener(marker, 'click', (function(marker, i) {
    return function() {
      map.panTo(marker.getPosition());
      infowindow.setContent('<div class="map-infowindow"><a href="' + locations[i]['path'] + '">' + locations[i]['name'] +'</a></div>');
      infowindow.open(map, this);
    }
  })(marker, i));
}

jQuery(document).ready(function($) {

  $('.map-toggle').on('click', function(e) {
    e.preventDefault();
    var target = $(this).data('target');
    var action = null;

    if (target == 'tries') {
      if ($(this).hasClass('isHidden')) {
        $(this).removeClass('btn-default').addClass('btn-success');
        for (i = 0; i < markerList.length; i++) {
          if (target == 'tries' && !markerList[i].isTry) {
            markerList[i].setMap(action);
          }
        }
      } else {
        action = map;
        $(this).removeClass('btn-success').addClass('btn-default');
        for (i = 0; i < markerList.length; i++) {
          if (target == 'tries') {
            markerList[i].setMap(action);
          }
        }
      }
      $(this).toggleClass('isHidden');
    } else {
      if ($(this).hasClass('isHidden')) {
        $(this).removeClass('btn-default').addClass('btn-success');
        action = map;
      } else {
        $(this).removeClass('btn-success').addClass('btn-default');
      }
      for (i = 0; i < markerList.length; i++) {
        if (
          (target == 'bars' && markerList[i].isBar)
          || (target == 'restaurants' && !markerList[i].isBar)
        ) {
          markerList[i].setMap(action);
        }
      }
      $(this).toggleClass('isHidden');
    }

  });

});
</script>
