<% provide(:title, "#{@neighborhood.name} | Neighborhoods") %>

<section id="neighborhoods-single" class="pad">
	<div class="container">
		<div class="row">
			<div class="col-sm-12">
				<h1><%= @neighborhood.name %></h1><%=  %>
				<p><% if @neighborhood.hasParent %>Part of <%= link_to neighborhood_path(@neighborhood.parent_neighborhood_id) do %><%= @neighborhood.parent.name %><% end %>.<% end %> <% if !@childTypes.empty? %>Includes <%= @childTypes.map { |vtype| link_to vtype.name, vtype }.join(', ').html_safe %>.<% end %></p>
				<div class="row">
					<div class="col-md-8">
						<% if !@scopeTotal.empty? %>
						<table class="table">
						  <thead>
						    <tr>
						      <th>Name</th>
						      <th class="hidden-xs">Category</th>
									<th>Type</th>
						      <th class="hidden-xs text-center">Rating</th>
						      <th class="text-center">Price</th>
						      <th class="hidden-xs text-center">BYOB</th>
						    </tr>
						  </thead>
						  <tbody>
								<% @scopeTotal.each do |venue| %>
								<%
									if venue.venuetype.hasParent
										if venue.venuetype.parent.hasParent
											if venue.venuetype.parent.parent.hasParent
												@venuetypeTop = venue.venuetype.parent.parent.parent
											else
												@venuetypeTop = venue.venuetype.parent.parent
											end
										else
											@venuetypeTop = venue.venuetype.parent
										end
									else
										@venuetypeTop = venue.venuetype
									end
								%>
					      <tr>
					        <td><%= link_to venue, title: venue.name do %><%= venue.name %><% end %></td>
									<td class="hidden-xs"><%= link_to venuetype_path(@venuetypeTop) do %><%= @venuetypeTop.name %><% end %></td>
					        <td><%= link_to venue.venuetype do %><%= venue.venuetype.name %><% end %></td>
					        <td class="hidden-xs text-center"><%= number_with_precision(venue.ratings.average('rating'), precision: 2) %></td>
					        <td class="text-center"><% if venue.price %><%= render_price(venue.price) %><% else %>&mdash;<% end %></td>
					        <td class="hidden-xs text-center"><% if venue.byob %><i class="fa fa-check green"></i><% end %></td>
					      </tr>
						    <% end %>
						  </tbody>
						</table>
						<% end %>
					</div>
					<div class="col-md-4">
						<div id="google-map" class="map map-neighborhood"></div>
					</div>
				</div>
				<p class="text-center">
					<%= link_to 'Edit', edit_neighborhood_path(@neighborhood) %>&nbsp;&bull;&nbsp;<%= link_to new_venue_path({ :neighborhood_id => @neighborhood.id }) do %>Add a new venue in <%= @neighborhood.name %><% end %>
			</div>
		</div>
	</div>
</section>

<script type="text/javascript">
google.maps.event.addDomListener(window, 'load', initialize(41.92, -87.65));

var nBounds = new google.maps.LatLngBounds();

locations = [
  <% @scopeTotal.each do |venue| %>
  {
    id: <%= venue.id %>,
    lat: '<%= venue.latitude %>',
    lng: '<%= venue.longitude %>',
    name: '<%= venue.name %>',
    path: '<%= venue_path(venue) %>'
  },
  <% end %>
];

for (i = 0; i < locations.length; i++) {
  var iconSymbol;
  if (locations[i]['isBar']) {
    iconSymbol = '/images/mug.svg';
  } else {
    iconSymbol = '/images/spoon-knife.svg';
  }
	var thisLatLng = new google.maps.LatLng(locations[i]['lat'], locations[i]['lng'])
  marker = new google.maps.Marker({
    position: thisLatLng,
    map: map,
    icon: iconSymbol
  });
	nBounds.extend(thisLatLng);
  marker.set('id', locations[i]['id']);
  markerList.push(marker);

  google.maps.event.addListener(marker, 'click', (function(marker, i) {
    return function() {
      map.panTo(marker.getPosition());
      infowindow.setContent('<div class="map-infowindow"><a href="' + locations[i]['path'] + '">' + locations[i]['name'] +'</a></div>');
      infowindow.open(map, this);
    }
  })(marker, i));
}

map.fitBounds(nBounds);
</script>
